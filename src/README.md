# Ancient Sounds

Explore medieval and ancient music on the Internet Archive. Build M3U playlists with AI-powered topic refinement.

## Quick Start

```bash
# Just open index.html in your browser (desktop or mobile)
```

## Features

1. Browse **248 research threads** across **46 categories**
2. **AI-powered topic refinement** (via OpenRouter):
   - **Subdivide**: Split a topic into finer subtopics
   - **Related**: Find associated traditions across cultures
   - **Reword**: Generate alternative search queries
3. **Smart sorting** prioritizes actual music over lectures/documentaries
4. **Favorites & History** for personalization
5. **Save custom topics** generated by AI
6. **Sticky player** always visible at bottom
7. Export playlists as M3U files
8. **Full mobile support** with slide-out menus

## AI Refinement

When viewing any topic, click the AI buttons:

| Button | What it does |
|--------|-------------|
| üî¨ Subdivide | Splits topic into 5-8 specific subtopics |
| üîó Related | Finds associated musical traditions |
| ‚ú® Reword | Generates alternative search queries |

Click any generated topic chip to explore it. Click üíæ to save it permanently.

## Categories

| Section | Traditions |
|---------|-----------|
| **Western Medieval** | Survey, Early/High/Late Medieval, Courtly Love, Dance |
| **Gregorian & Plainchant** | Chant, Masses, Divine Office, Antiphons, Hymns, Psalmody |
| **Monastic** | Benedictine, Cistercian, Dominican, Franciscan, Solesmes |
| **French Medieval** | Troubadours, Trouv√®res, Notre Dame, Ars Antiqua/Nova/Subtilior |
| **Italian Medieval** | Trecento, Landini, Lauda, Ballata, Caccia |
| **Iberian Medieval** | Cantigas, Mozarabic, Sephardic, Catalan, Galician |
| **Germanic Medieval** | Minnesinger, Meistersinger, Carmina Burana |
| **English Medieval** | Sarum Use, Old Hall MS, Dunstable, Carol |
| **Byzantine** | Chant, Octoechos, Kontakion, Mount Athos |
| **Slavic Orthodox** | Russian, Znamenny, Kievan, Serbian, Bulgarian |
| **Oriental Orthodox** | Coptic, Ethiopian, Armenian, Syriac, Maronite, Georgian |
| **Jewish Synagogue** | Cantorial, Nusach, High Holy Days, Kol Nidre |
| **Jewish Regional** | Ashkenazi, Sephardic, Mizrachi, Yemenite, Ladino |
| **Jewish Mystical** | Kabbalah, Hasidic, Chabad, Carlebach, Piyyut |
| **Klezmer & Yiddish** | Klezmer, Yiddish Song, Theater |
| **Quranic Arts** | Recitation, Tajwid, Adhan, Nasheed |
| **Sufi** | Qawwali, Nusrat, Mevlevi, Dhikr, Gnawa |
| **Arabic Classical** | Maqam, Tarab, Oud, Umm Kulthum, Andalusian |
| **Persian Classical** | Radif, Dastgah, Tar, Santur, Shajarian |
| **Turkish Classical** | Makam, Fasƒ±l, Ney, Ottoman Court |
| **Indian Classical** | Hindustani, Carnatic, Raga, Dhrupad, Sitar |
| **Indian Sacred** | Vedic, Bhajan, Kirtan, Mantra, Sikh |
| **Buddhist** | Tibetan, Sh≈çmy≈ç, Zen, Overtone |
| **East Asian** | Gagaku, Noh, Shakuhachi, Guqin, Gamelan |
| **Ancient Mediterranean** | Greek, Roman, Seikilos, Lyre |
| **Ancient Near East** | Mesopotamian, Hurrian, Egyptian, Hebrew |
| **Renaissance Sacred** | Mass, Palestrina, Victoria, Lassus, Byrd, Tallis |
| **Renaissance Secular** | Madrigal, Chanson, Villancico |
| **Renaissance Instrumental** | Consort, Lute, Dowland, Dance |
| **Instruments** | Plucked, Bowed, Wind, Keyboard |
| **Ensembles** | Anonymous 4, Hilliard, Tallis Scholars, Sequentia |
| **Composers** | Hildegard, P√©rotin, Machaut, Dufay, Monteverdi |
| **Forms** | Liturgical, Polyphonic, Manuscripts |
| **Archive** | 78rpm, LibriVox, Smithsonian, Lomax |

## Smart Sorting

Results are automatically sorted to prioritize:
- Items with "chant", "music", "song", "hymn" in title (boost)
- Items with "performance", "recording", "concert" (boost)
- Deprioritizes: lectures, documentaries, audiobooks, podcasts

## Personalization

- ‚≠ê **Favorites**: Click the star next to any topic to save it
- üíæ **Saved Topics**: AI-generated topics you've saved
- üïê **Recent**: Your browsing history (last 5 topics)

All personalization data is stored in localStorage.

## Mobile Interface

On phones and tablets (< 900px):

- **‚ò∞ Menu**: Tap to open sidebar with all categories
- **üéµ Playlist**: Tap to open playlist panel (shows track count badge)
- **Swipe-friendly**: Sidebar and playlist slide in/out
- **Compact player**: Shows track name and play/pause, with progress bar at top
- **Touch-optimized**: Large tap targets for all buttons
- **Horizontal scroll**: AI refinement buttons scroll horizontally
- **2-column grid**: Results display in two columns

## Project Structure

```
ia-playlist-builder/
‚îú‚îÄ‚îÄ index.html              # Complete browser application
‚îú‚îÄ‚îÄ package.json            # Node.js config for testing
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config.js           # Configuration with documented assumptions
‚îÇ   ‚îú‚îÄ‚îÄ logger.js           # Structured logging
‚îÇ   ‚îú‚îÄ‚îÄ api.js              # API client with retry, cache, validation
‚îÇ   ‚îú‚îÄ‚îÄ playlist.js         # Playlist management and M3U export
‚îÇ   ‚îî‚îÄ‚îÄ check-assumptions.js # Runtime assumption checker
‚îî‚îÄ‚îÄ test/
    ‚îú‚îÄ‚îÄ run.js              # Test runner
    ‚îú‚îÄ‚îÄ mocks.js            # Mock API responses
    ‚îú‚îÄ‚îÄ api.test.js         # API tests (16 tests)
    ‚îî‚îÄ‚îÄ playlist.test.js    # Playlist tests (19 tests)
```

## Architecture Decisions

| Decision | Reason | Tradeoff |
|----------|--------|----------|
| Single HTML file | No build, just open | Harder to maintain |
| Modular src/ files | Testable in Node.js | Duplication with index.html |
| In-memory cache | Reduces API calls | Lost on refresh |
| localStorage | Simple persistence | 5MB limit |
| 30s timeout | Archive is slow | Long wait on failure |
| 3 retries | Handle transient errors | Delays final error |
| Stale-while-revalidate | Show something on error | May show old data |

## Defensive Patterns

Every function:
1. **Validates inputs** ‚Äî type checks, range checks, format checks
2. **Checks response shapes** ‚Äî verifies expected properties exist
3. **Logs what it does** ‚Äî structured logging with context
4. **Handles errors explicitly** ‚Äî specific error types, not just throw

Example from `api.js`:
```javascript
// Validate input
validateString(query, 'query');

// Check response shape
checkResponseShape(result.data, {
  'response': 'object',
  'response.docs': 'array',
  'response.numFound': 'number',
}, url);

// Log assumption checks
log.assumption('Response has valid response.docs', true);
```

## Expected Console Output

### Successful search:
```
[12:34:56][INFO ][api:search] Searching {"query":"collection:netlabels","rows":40}
[12:34:56][DEBUG][api] Fetching (attempt 1) {"url":"https://archive.org/..."}
[12:34:57][DEBUG][api] 200 (441ms) {"url":"..."}
[12:34:57][DEBUG][api] Assumption OK: Response has valid response.docs
[12:34:57][INFO ][api:search] Found 52847 total, returning 40
```

### Cache hit:
```
[12:35:00][DEBUG][api] Cache HIT (age: 3s) {"url":"..."}
```

### Network error with retry:
```
[12:36:00][DEBUG][api] Fetching (attempt 1)
[12:36:30][WARN ][api] Request timeout
[12:36:30][INFO ][api] Retrying in 1000ms...
[12:36:31][DEBUG][api] Fetching (attempt 2)
```

### Stale cache fallback:
```
[12:38:00][WARN ][api] HTTP 503
[12:38:00][WARN ][api] Returning stale cache after error
```

## Running Tests

```bash
# All tests
npm test

# Just API tests
npm run test:api

# Just playlist tests  
npm run test:playlist

# Check assumptions (requires network)
npm run check
```

Test output shows exactly what each function checks:
```
üìã Search Tests
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[INFO ][api:search] Searching {"query":"collection:netlabels"}
[DEBUG][api] Assumption OK: Response has valid response
[DEBUG][api] Assumption OK: Response has valid response.docs
  ‚úì returns docs from valid search
```

## Assumptions

Documented in `src/config.js`. Each assumption includes:
- What we assume
- How to verify it
- What happens if wrong

Key assumptions:
1. Archive API returns JSON with documented shape
2. VBR MP3 derivatives exist for most audio items
3. Browsers support MP3 and OGG playback
4. localStorage is available and has ~5MB space

## Known Limitations

1. No pagination ‚Äî only first 40 results
2. No playlist reordering ‚Äî add/remove only
3. No offline mode ‚Äî requires network
4. FLAC not playable ‚Äî browsers don't support it
5. Mobile untested ‚Äî may have issues

## Provenance

- **Human**: Requirements, review, testing
- **Claude**: Code structure, API research, error handling patterns

## Maintenance

Experimental. May fix bugs if it breaks. No guarantees.

## License

Public domain. Do what you want.
